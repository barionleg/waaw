<!DOCTYPE html>
<html>
<!--
 csound.js canvas example
 Copyright (C) 2017 V Lazzarini
-->

<head>
  <title>WebAudio Csound </title>
  <style type="text/css">
    * {
      padding: 0;
      margin: 0;
    }

    html,
    body {
      min-height: 100% !important;
      height: 100%;
      overflow: hidden;
    }

    canvas.cnvs {
      touch-action: none;
      font-family: "Courier New";
      color: #FCF477;
      background-color: #FF0000;
      height: 100%;
      width: 100%;
    }

    #messages {
      z-index: 100;
      float: left;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Monospace;
    }
  </style>

</head>

<body>
  <H1 id='tit'>Canvas Synth</H1>
  <div id="messages"> </div>
  <p>
    <canvas class="cnvs" id="cnvs" onmousemove="cnvs_getCoordinates(event)" onmousedown="cnvs_play(event)" onmouseup="cnvs_stop(event)" onmouseout="cnvs_out()" ontouchmove="cnvs_getTCoordinates(event)" ontouchstart="cnvs_tplay(event)" ontouchend="cnvs_stop(event)">
      </canvas>
  </p>
  <script type="text/javascript" src="js/csound.js"></script>
  <script type="text/javascript">
    const cons = document.getElementById("messages");
    const cnvs = document.getElementById("cnvs");
    const tit = document.getElementById("tit");
    cons.innerText = "Loading Csound...";
    // called by csound.js
    function moduleDidLoad() {
      csound.Play();
      csound.CompileOrc(
        "instr 1 \n" +
        "kfr chnget \"freq\" \n" +
        "kamp chnget \"amp\" \n" +
        "kcf chnget \"cf\" \n" +
        "ka linenr (400-kamp)/400,.01,0.1,0.01 \n" +
        "a1 vco2   ka,440+kfr \n" +
        "kcf port kcf,0.01 \n" +
        "a2 moogvcf a1, kcf*(1+ka), 0.8 \n" +
        "al,ar freeverb a2,a2, 0.3, 0.8 \n" +
        "outs al,ar \n" +
        "endin");
      csound.SetChannel("cf", 1000);
      cons.remove();
      tit.remove();
      resize_cnvs();
    }


    function resize_cnvs() {

      let w = document.body.clientWidth;
      let h = document.body.clientHeight;

      if (cnvs.width != w || cnvs.height != h) {
        cnvs.width = w;
        cnvs.height = h;
      }
    }

    resize_cnvs();

    function attachListeners() {}

    var count = 0;

    function handleMessage(message) {cons.innerText = message;}

    var playing = false;

    function cnvs_getCoordinates(e) {
      if (playing) {
        var c = document.getElementById("cnvs");
        var ctx = c.getContext("2d");
        var rect = c.getBoundingClientRect();
        x = e.clientX - rect.left
        y = e.clientY - rect.top
        csound.SetChannel('amp', y);
        csound.SetChannel('freq', x);

        ctx.clearRect(0, 0, cnvs.width, cnvs.height);
        ctx.fillStyle = "#0000FF";
        ctx.fillRect(x, y, 10, 10);
      }
    }

    var started = false;

    function cnvs_play(e) {
      if (started == false) {
        CSOUND_AUDIO_CONTEXT.resume();
        started = true;
      }
      csound.Event("i1 0 -1");
      csound.SetChannel('cf', 3000);
      var c = document.getElementById("cnvs");
      var ctx = c.getContext("2d");
      var rect = c.getBoundingClientRect();
      x = e.clientX - rect.left
      y = e.clientY - rect.top
      csound.SetChannel('amp', y);
      csound.SetChannel('freq', x);
      ctx.fillStyle = "#0000FF";
      ctx.fillRect(x, y, 10, 10);
      playing = true;
    }

    function cnvs_stop(e) {
      csound.Event("i-1 0 -1");
      csound.SetChannel('cf', 1000);
      var c = document.getElementById("cnvs");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, cnvs.width, cnvs.height);
      playing = false;
    }

    function cnvs_out() {}

    function cnvs_getTCoordinates(e) {
      if (playing) {
        var c = document.getElementById("cnvs");
        var ctx = c.getContext("2d");
        var rect = c.getBoundingClientRect();
        touches = e.touches;
        t = touches[0];
        x = t.clientX - rect.left
        y = t.clientY - rect.top
        csound.SetChannel('amp', y);
        csound.SetChannel('freq', x);

        ctx.clearRect(0, 0, cnvs.width, cnvs.height);
        ctx.fillStyle = "#0000FF";
        ctx.fillRect(x, y, 10, 10);
      }
    }

    var started = false;

    function cnvs_tplay(e) {
      if (started == false) {
        CSOUND_AUDIO_CONTEXT.resume();
        started = true;
      }
      csound.Event("i1 0 -1");
      csound.SetChannel('cf', 3000);
      var c = document.getElementById("cnvs");
      var ctx = c.getContext("2d");
      var rect = c.getBoundingClientRect();
      touches = e.touches;
      t = touches[0];
      x = t.clientX - rect.left
      y = t.clientY - rect.top
      csound.SetChannel('amp', y);
      csound.SetChannel('freq', x);
      ctx.fillStyle = "#0000FF";
      ctx.fillRect(x, y, 10, 10);
      playing = true;
    }

    function cnvs_tstop(e) {
      csound.Event("i-1 0 -1");
      csound.SetChannel('cf', 1000);
      var c = document.getElementById("cnvs");
      var ctx = c.getContext("2d");
      ctx.clearRect(0, 0, cnvs.width, cnvs.height);
      playing = false;
    }
    document.ontouchmove = function(event) {
      event.preventDefault();
    };

    window.oncontextmenu = function(event) {
      event.preventDefault();
      event.stopPropagation();
      return false;
    };
  </script>
</body>

</html>
